<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <%- include('partials/header') %>
    <main class="container mt-4">
        <h1 class="text-center">Каталог товаров</h1>
        <form id="searchForm" method="GET" action="/products">
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Поиск по названию" name="search" value="<%= search || '' %>">
                <button class="btn btn-outline-secondary" type="submit">Поиск</button>
            </div>
        </form>
        
        <div class="row justify-content-center">
            <div class="col-lg-3 mb-4">
                <h2>Категории</h2>
                <ul class="list-group">
                    <% categories.forEach(category => { %>
                        <li class="list-group-item">
                            <a href="/products?category=<%= category.name %>"><%= category.name %></a>
                            <ul class="list-group">
                                <% category.Subcategories.forEach(subcategory => { %>
                                    <li class="list-group-item">
                                        <a href="/products?category=<%= category.name %>&subcategory=<%= subcategory %>"><%= subcategory %></a>
                                    </li>
                                <% }) %>
                            </ul>
                        </li>
                    <% }) %>
                </ul>
                
                <h2>Фильтры</h2>
                <form id="filterForm" method="GET" action="/products">
                    <input type="hidden" name="category" value="<%= category || '' %>">
                    <input type="hidden" name="subcategory" value="<%= subcategory || '' %>">

                    <% if (subcategory === 'Худи' || subcategory === 'Футболки' || subcategory === 'Nike' || subcategory === 'Adidas' || subcategory === 'Asics' || subcategory === 'Salomon') { %>
                        <div class="mb-3">
                            <label class="form-label">Цвет</label>
                            <div>
                                <input type="checkbox" name="color" value="Белый" <%= color.includes('Белый') ? 'checked' : '' %>> Белый<br>
                                <input type="checkbox" name="color" value="Красный" <%= color.includes('Красный') ? 'checked' : '' %>> Красный<br>
                                <input type="checkbox" name="color" value="Синий" <%= color.includes('Синий') ? 'checked' : '' %>> Синий<br>
                            </div>
                        </div>
                    <% } %>

                    <% if (subcategory === 'Худи' || subcategory === 'Футболки' || subcategory === 'Nike' || subcategory === 'Adidas' || subcategory === 'Рюкзаки' || subcategory === 'Кошельки') { %>
                        <div class="mb-3">
                            <label class="form-label">Бренд</label>
                            <div>
                                <input type="checkbox" name="brand" value="Nike" <%= brand.includes('Nike') ? 'checked' : '' %>> Nike<br>
                                <input type="checkbox" name="brand" value="Adidas" <%= brand.includes('Adidas') ? 'checked' : '' %>> Adidas<br>
                                <input type="checkbox" name="brand" value="Jordan" <%= brand.includes('Jordan') ? 'checked' : '' %>> Jordan<br>
                            </div>
                        </div>
                    <% } %>

                    <% if (subcategory === 'Худи') { %>
                        <div class="mb-3">
                            <label class="form-label">Коллекция</label>
                            <div>
                                <input type="checkbox" name="collection" value="Осень" <%= collection.includes('Осень') ? 'checked' : '' %>> Осень<br>
                                <input type="checkbox" name="collection" value="Зима" <%= collection.includes('Зима') ? 'checked' : '' %>> Зима<br>
                                <input type="checkbox" name="collection" value="Лето" <%= collection.includes('Лето') ? 'checked' : '' %>> Лето<br>
                            </div>
                        </div>
                    <% } %>

                    <% if (subcategory === 'Asics' || subcategory === 'Salomon') { %>
                        <div class="mb-3">
                            <label class="form-label">Размер</label>
                            <div>
                                <input type="checkbox" name="size" value="38" <%= size.includes('38') ? 'checked' : '' %>> 38<br>
                                <input type="checkbox" name="size" value="39" <%= size.includes('39') ? 'checked' : '' %>> 39<br>
                                <input type="checkbox" name="size" value="40" <%= size.includes('40') ? 'checked' : '' %>> 40<br>
                                <input type="checkbox" name="size" value="41" <%= size.includes('41') ? 'checked' : '' %>> 41<br>
                                <input type="checkbox" name="size" value="42" <%= size.includes('42') ? 'checked' : '' %>> 42<br>
                                <input type="checkbox" name="size" value="43" <%= size.includes('43') ? 'checked' : '' %>> 43<br>
                            </div>
                        </div>
                    <% } %>

                    <% if (subcategory === 'Смартфоны') { %>
                        <div class="mb-3">
                            <label class="form-label">Год релиза</label>
                            <div>
                                <input type="checkbox" name="releaseYear" value="2022" <%= releaseYear.includes('2022') ? 'checked' : '' %>> 2022<br>
                                <input type="checkbox" name="releaseYear" value="2023" <%= releaseYear.includes('2023') ? 'checked' : '' %>> 2023<br>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Производитель</label>
                            <div>
                                <input type="checkbox" name="manufacturer" value="Apple" <%= manufacturer.includes('Apple') ? 'checked' : '' %>> Apple<br>
                                <input type="checkbox" name="manufacturer" value="Samsung" <%= manufacturer.includes('Samsung') ? 'checked' : '' %>> Samsung<br>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Объем встроенной памяти</label>
                            <div>
                                <input type="checkbox" name="storage" value="128" <%= storage.includes('128') ? 'checked' : '' %>> 128GB<br>
                                <input type="checkbox" name="storage" value="256" <%= storage.includes('256') ? 'checked' : '' %>> 256GB<br>
                            </div>
                        </div>
                    <% } %>

                    <% if (subcategory === 'Наушники') { %>
                        <div class="mb-3">
                            <label class="form-label">Производитель</label>
                            <div>
                                <input type="checkbox" name="manufacturer" value="Sony" <%= manufacturer.includes('Sony') ? 'checked' : '' %>> Sony<br>
                                <input type="checkbox" name="manufacturer" value="Bose" <%= manufacturer.includes('Bose') ? 'checked' : '' %>> Bose<br>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Способ передачи сигнала</label>
                            <div>
                                <input type="checkbox" name="signalType" value="Wireless" <%= signalType.includes('Wireless') ? 'checked' : '' %>> Wireless<br>
                                <input type="checkbox" name="signalType" value="Wired" <%= signalType.includes('Wired') ? 'checked' : '' %>> Wired<br>
                            </div>
                        </div>
                    <% } %>

                    <button type="submit" class="btn btn-primary">Применить фильтры</button>
                </form>
            </div>
            
            <div class="col-lg-9">
                <div class="row">
                    <div class="input-group mb-3">
                        <label class="input-group-text" for="sortSelect">Сортировка:</label>
                        <select class="form-select" id="sortSelect">
                            <option value="" <% if (!sort) { %>selected<% } %>>По умолчанию</option>
                            <option value="price_asc" <% if (sort === 'price_asc') { %>selected<% } %>>По цене (возрастание)</option>
                            <option value="price_desc" <% if (sort === 'price_desc') { %>selected<% } %>>По цене (убывание)</option>
                            <option value="name_asc" <% if (sort === 'name_asc') { %>selected<% } %>>По наименованию (А-Я)</option>
                            <option value="name_desc" <% if (sort === 'name_desc') { %>selected<% } %>>По наименованию (Я-А)</option>
                            <option value="availability" <% if (sort === 'availability') { %>selected<% } %>>По наличию</option>
                        </select>
                    </div>
                    <% products.forEach(product => { %>
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <img src="<%= product.imageUrl %>" class="card-img-top" alt="<%= product.name %>">
                                <div class="card-body">
                                    <h5 class="card-title"><a href="/products/<%= product.id %>"><%= product.name %></a></h5>
                                    <p class="card-text">Цена: <%= product.price %></p>
                                    <p class="card-text"><%= product.shortDescription %></p>
                                    <form class="add-to-cart-form" id="add-to-cart-form-<%= product.id %>" action="/cart/add" method="POST">
                                        <% if (user && user.id) { %>
                                            <input type="hidden" name="userId" value="<%= user.id %>">
                                        <% } %>
                                        <input type="hidden" name="productId" value="<%= product.id %>">
                                        <input type="hidden" name="name" value="<%= product.name %>">
                                        <input type="hidden" name="price" value="<%= product.price %>">
                                        <button type="submit" class="btn btn-primary">Купить</button>
                                    </form>
                                    <div class="message mt-3" id="message-<%= product.id %>"></div>                                    
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sortSelect = document.getElementById('sortSelect');
            sortSelect.addEventListener('change', function() {
                const selectedOption = sortSelect.value;
                const url = new URL(window.location.href);
                url.searchParams.set('sort', selectedOption);
                window.location.href = url.toString();
            });
        });

        document.querySelectorAll('.add-to-cart-form').forEach(form => {
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                const formData = new FormData(event.target);

                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                try {
                    const response = await fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const messageDivId = 'message-' + data.productId;
                    const messageDiv = document.getElementById(messageDivId);
                    const result = await response.json();

                    if (response.ok) {
                        messageDiv.textContent = result.message || 'Product added to cart successfully';
                        messageDiv.className = 'alert alert-success';
                    } else {
                        messageDiv.textContent = result.error || 'Error adding product to cart';
                        messageDiv.className = 'alert alert-danger';
                    }

                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 3000);
                } catch (error) {
                    console.error('Error adding product to cart:', error);
                    const messageDivId = 'message-' + data.productId;
                    const messageDiv = document.getElementById(messageDivId);
                    messageDiv.textContent = 'Error adding product to cart';
                    messageDiv.className = 'alert alert-danger';

                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 3000);
                }
            });
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
